services:

  infra-scanner:
    build:
      context: .
      dockerfile: Dockerfile.infra_scanner
    container_name: infra-scanner
    restart: unless-stopped
    volumes:
      - ./inventory.json:/app/inventory.json:ro
      - ./credentials.json:/app/credentials.json:ro
      - ./.env:/app/.env:ro
    depends_on:
      - netbox

  portainer:
    container_name: portainer
    image: portainer/portainer-ce:latest
    restart: unless-stopped
    security_opt:
      - "no-new-privileges:true"
    ports:
      - "9443:9443"
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "${DOCKER_ROOT}/portainer/data:/data"
    networks:
      - pi-services

  frigate:
    container_name: frigate
    privileged: true
    restart: unless-stopped
    stop_grace_period: 30s
    image: ghcr.io/blakeblackshear/frigate:stable
    shm_size: "512mb"
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    devices:
      - "/dev/bus/usb:/dev/bus/usb"
      - "/dev/apex_0:/dev/apex_0"
      - "/dev/dri/renderD128:/dev/dri/renderD128"
      - "/dev/video10:/dev/video10"
      - "/dev/video11:/dev/video11"
      - "/dev/video12:/dev/video12"
      - "/dev/video13:/dev/video13"
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "${DOCKER_ROOT}/config:/config"
      - "${DOCKER_ROOT}/storage:/media/frigate"
      - type: tmpfs
        target: /tmp/cache
        tmpfs:
          size: 1000000000
    ports:
      - "5000:5000"
      - "8971:8971"
      - "8554:8554"
      - "8555:8555/tcp"
      - "8555:8555/udp"
    environment:
      FRIGATE_RTSP_PASSWORD: "${FRIGATE_RTSP_PASSWORD}"
      FRIGATE_MQTT_ENABLED: "True"
      FRIGATE_MQTT_HOST: "mqtt"
      FRIGATE_MQTT_PORT: "1883"
      FRIGATE_MQTT_USER: "${FRIGATE_MQTT_USER}"
      FRIGATE_MQTT_PASSWORD: "${FRIGATE_MQTT_PASSWORD}"
    networks:
      - pi-services
    depends_on:
      - mqtt

  homeassistant:
    container_name: homeassistant
    image: "ghcr.io/home-assistant/home-assistant:stable"
    restart: unless-stopped
    privileged: true
    network_mode: host
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    volumes:
      - "${DOCKER_ROOT}/homeassistant:/config"
      - "/etc/localtime:/etc/localtime:ro"
    depends_on:
      - mqtt

  mqtt:
    container_name: mqtt
    image: eclipse-mosquitto:latest
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - "${DOCKER_ROOT}/mosquitto/config:/mosquitto/config"
      - "${DOCKER_ROOT}/mosquitto/data:/mosquitto/data"
      - "${DOCKER_ROOT}/mosquitto/log:/mosquitto/log"
    networks:
      - pi-services

  adguardhome:
    container_name: adguardhome
    image: adguard/adguardhome:latest
    restart: unless-stopped
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "3000:3000/tcp"
      - "8080:80/tcp"
    volumes:
      - "${DOCKER_ROOT}/adguardhome/work:/opt/adguardhome/work"
      - "${DOCKER_ROOT}/adguardhome/conf:/opt/adguardhome/conf"
      - "${DOCKER_ROOT}/npm/letsencrypt:/opt/adguardhome/conf/letsencrypt:ro"
    networks:
      - pi-services
    extra_hosts:
      - "${DOMAIN}:${INTERNAL_HOST_IP}"
      - "${EXTERNAL_DNS_NAME}:${EXTERNAL_DNS_IP}"

  vaultwarden:
    container_name: vaultwarden
    image: vaultwarden/server:latest
    restart: unless-stopped
    environment:
      SIGNUPS_ALLOWED: "${SIGNUPS_ALLOWED}"
      WEBSOCKET_ENABLED: "true"
      DOMAIN: "https://vault.${DOMAIN}"
    volumes:
      - "${DOCKER_ROOT}/vaultwarden:/data"
    networks:
      - pi-services

  npm:
    container_name: npm
    image: jc21/nginx-proxy-manager:latest
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    ports:
      - "80:80/tcp"
      - "443:443/tcp"
      - "8181:81/tcp"
    volumes:
      - "${DOCKER_ROOT}/npm/data:/data"
      - "${DOCKER_ROOT}/npm/letsencrypt:/etc/letsencrypt"
    networks:
      - pi-services

  step-ca:
    image: "smallstep/step-ca"
    container_name: "step-ca"
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    networks:
      - "pi-services"
    ports:
      - "9000:9000"
    volumes:
      - "${DOCKER_ROOT}/step-ca:/home/step"
    environment:
      DOCKER_STEPCA_INIT_NAME: "Sovereign CA"
      DOCKER_STEPCA_INIT_DNS_NAMES: "localhost,step-ca,${STEP_CA_DNS_IP}"
      DOCKER_STEPCA_INIT_PASSWORD: "${STEPCA_PASSWORD}"
      DOCKER_STEPCA_INIT_PROVISIONER_NAME: "${STEPCA_PROVISIONER_NAME}"
      DOCKER_STEPCA_INIT_PROVISIONER_PASSWORD: "${STEPCA_PROVISIONER_PASSWORD}"
    restart: "unless-stopped"

  fail2ban:
    image: crazymax/fail2ban:latest
    container_name: fail2ban
    restart: unless-stopped
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - "${DOCKER_ROOT}/fail2ban/data:/data"
      - "${DOCKER_ROOT}/npm/data/logs:/var/log/npm:ro"
      - "${DOCKER_ROOT}/forgejo/data/gitea/log:/var/log/forgejo:ro"
    environment:
      TZ: "${TZ}"
      F2B_LOG_TARGET: "STDOUT"
      F2B_LOG_LEVEL: "INFO"
      F2B_DB_PURGE_AGE: "1d"
      SS_TPL_DESTMAIL: "${BACKUP_EMAIL}"
      SS_TPL_SENDERNAME: "Sovereign-Security"
      SS_TPL_SENDERMAIL: "${BACKUP_EMAIL}"
      SS_TPL_SMTPHOST: "${SMTP_HOST}"
      SS_TPL_SMTPPORT: "${SMTP_PORT}"
      SS_TPL_SMTPUSER: "${BACKUP_EMAIL}"
      SS_TPL_SMTPPASS: "${BACKUP_PASSWORD}"
      SS_TPL_SMTPTLS: "${SMTP_TLS}"

  glances:
    image: nicolargo/glances:latest
    container_name: glances
    restart: unless-stopped
    pid: host
    network_mode: host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - "GLANCES_OPT: -w"

  nextcloud-db:
    image: mariadb:10.11
    container_name: nextcloud-db
    restart: always
    command: >
      --transaction-isolation=READ-COMMITTED
      --log-bin=binlog
      --binlog-format=ROW
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    env_file: .env
    networks:
      - nextcloud-internal
    volumes:
      - "${DOCKER_ROOT}/nextcloud/db:/var/lib/mysql"
    environment:
      MYSQL_ROOT_PASSWORD: "${NEXTCLOUD_DB_ROOT_PASSWORD}"
      MYSQL_PASSWORD: "${NEXTCLOUD_DB_PASSWORD}"
      MYSQL_DATABASE: "${NEXTCLOUD_DB_NAME}"
      MYSQL_USER: "${NEXTCLOUD_DB_USER}"

  nextcloud-redis:
    image: redis:alpine
    container_name: nextcloud-redis
    restart: always
    networks:
      - nextcloud-internal

  nextcloud-app:
    image: nextcloud:stable
    container_name: nextcloud-app
    restart: always
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    depends_on:
      - nextcloud-db
      - nextcloud-redis
    env_file: .env
    ports:
      - "8088:80"
    networks:
      - pi-services
      - nextcloud-internal
    volumes:
      - "${DOCKER_ROOT}/nextcloud/data:/var/www/html"
    environment:
      MYSQL_PASSWORD: "${NEXTCLOUD_DB_PASSWORD}"
      MYSQL_DATABASE: "${NEXTCLOUD_DB_NAME}"
      MYSQL_USER: "${NEXTCLOUD_DB_USER}"
      MYSQL_HOST: nextcloud-db
      REDIS_HOST: nextcloud-redis
      NEXTCLOUD_TRUSTED_DOMAINS: "${NEXTCLOUD_TRUSTED_DOMAINS}"
      MAIL_FROM_ADDRESS: "${NEXTCLOUD_MAIL_FROM_ADDRESS}"
      MAIL_DOMAIN: "${NEXTCLOUD_MAIL_DOMAIN}"
      SMTP_HOST: "${NEXTCLOUD_MAIL_SMTPHOST}"
      SMTP_PORT: "${NEXTCLOUD_MAIL_SMTPPORT}"
      SMTP_SECURE: "${NEXTCLOUD_MAIL_SMTPSECURE}"
      SMTP_AUTHTYPE: LOGIN
      SMTP_AUTH: "${NEXTCLOUD_MAIL_SMTPAUTH}"
      SMTP_NAME: "${NEXTCLOUD_MAIL_SMTPNAME}"
      SMTP_PASSWORD: "${NEXTCLOUD_MAIL_SMTPPASSWORD}"

  # --- Communication Services ---
  coturn:
    image: coturn/coturn:latest
    container_name: coturn
    restart: unless-stopped
    networks:
      - pi-services
    ports:
      - "3478:3478/tcp"
      - "3478:3478/udp"
    environment:
      - TURN_SECRET=${COTUR_SECRET}
      - TURN_SERVER_NAME=turn.${DOMAIN}
      - TURN_REALM=turn.${DOMAIN}
    command:
      - --log-file=stdout
      - --listening-port=3478
      - --min-port=49152
      - --max-port=65535
      - --user-quota=100
      - --total-quota=1000
      - --stale-nonce
      - --no-stdout-log

  # --- Nextcloud High Performance Backend ---
  notify-push:
    image: nextcloud:stable
    container_name: notify-push
    restart: unless-stopped
    depends_on:
      - nextcloud-app
      - nextcloud-db
      - nextcloud-redis
    environment:
      PORT: "7867"
      NEXTCLOUD_URL: "https://nextcloud.${DOMAIN}"
    volumes:
      - "${DOCKER_ROOT}/nextcloud/data:/var/www/html"
    #    entrypoint: ["tail", "-f", "/dev/null"]
    entrypoint: [ "/var/www/html/custom_apps/notify_push/bin/aarch64/notify_push" ]
    command: [ "/var/www/html/config/config.php" ]
    #    entrypoint: /bin/sh
    #    command: -c "/var/www/html/custom_apps/notify_push/bin/aarch64/notify_push /var/www/html/config/config.php"
    networks:
      - pi-services
      - nextcloud-internal

  homarr:
    container_name: homarr
    image: ghcr.io/ajnart/homarr:latest
    restart: unless-stopped
    volumes:
      - "${DOCKER_ROOT}/homarr/configs:/app/data/configs"
      - "${DOCKER_ROOT}/homarr/icons:/app/public/icons"
      - "/var/run/docker.sock:/var/run/docker.sock"
    ports:
      - "7575:7575"
    environment:
      - TZ="${TZ}"
    networks:
      - pi-services

  forgejo-db:
    container_name: forgejo-db
    image: mariadb:10.11
    restart: always
    networks:
      - pi-services
    environment:
      MYSQL_ROOT_PASSWORD: "${NEXTCLOUD_DB_ROOT_PASSWORD}"
      MYSQL_PASSWORD: "${FORGEJO_DB_PASSWORD}"
      MYSQL_DATABASE: "${FORGEJO_DB_NAME}"
      MYSQL_USER: "${FORGEJO_DB_USER}"
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    volumes:
      - "${DOCKER_ROOT}/forgejo/db:/var/lib/mysql"

  forgejo:
    container_name: forgejo
    image: codeberg.org/forgejo/forgejo:14
    restart: unless-stopped
    depends_on:
      - forgejo-db
    networks:
      - pi-services
    environment:
      - USER=git
      - USER_UID=1000
      - USER_GID=1000
      - FORGEJO__database__DB_TYPE=mysql
      - FORGEJO__database__HOST=forgejo-db:3306
      - FORGEJO__database__NAME=${FORGEJO_DB_NAME}
      - FORGEJO__database__USER=${FORGEJO_DB_USER}
      - FORGEJO__database__PASSWD="${FORGEJO_DB_PASSWORD}"
      - FORGEJO__server__DOMAIN=${DOMAIN}
      - FORGEJO__server__ROOT_URL=https://git.${DOMAIN}
      - FORGEJO__server__HTTP_PORT=3000
    labels:
      - "com.centurylinklabs.watchtower.enable=false"
    volumes:
      - "${DOCKER_ROOT}/forgejo/data:/data"
      - "/etc/localtime:/etc/localtime:ro"
    ports:
      - "2222:22"

  signal-api:
    image: bbernhard/signal-cli-rest-api:latest
    container_name: signal-api
    environment:
      - MODE=json-rpc
      - SIGNAL_CLI_API_PASSWORD="${SIGNAL_CLI_API_PASSWORD}"
    ports:
      - "8090:8080"
    volumes:
      - "${DOCKER_ROOT}/signal-data:/home/.local/share/signal-cli"
    restart: unless-stopped

  # --- Lightweight Matrix Alternative (Optional) ---
  # Uncomment this block if you want to run a lightweight Matrix server (Conduit)
  # directly on the Raspberry Pi for small, private groups.
  # Note: For large communities (1000+ users), an external Synapse node is recommended.
  #
  #  matrix:
  #    image: matrixconduit/matrix-conduit:latest
  #    container_name: matrix
  #    restart: unless-stopped
  #    environment:
  #      CONDUIT_SERVER_NAME: "matrix.${DOMAIN}"
  #      CONDUIT_DATABASE_BACKEND: "rocksdb"
  #      CONDUIT_ALLOW_REGISTRATION: "false"
  #    volumes:
  #      - "${DOCKER_ROOT}/matrix:/var/lib/matrix-conduit"
  #    ports:
  #      - "6167:6167"
  #    networks:
  #      - pi-services

  netbox-db:
    container_name: netbox-db
    image: postgres:15-alpine
    # PostgreSQL backend for Netbox infrastructure management
    restart: unless-stopped
    env_file: .env
    environment:
      POSTGRES_DB: "${NETBOX_DB_NAME}"
      POSTGRES_USER: "${NETBOX_DB_USER}"
      POSTGRES_PASSWORD: "${NETBOX_DB_PASSWORD}"
    volumes:
      - "${DOCKER_ROOT}/netbox/db:/var/lib/postgresql/data"
    networks:
      - pi-services

  netbox-redis:
    container_name: netbox-redis
    image: redis:7-alpine
    # Redis instance for Netbox caching and queuing
    restart: unless-stopped
    networks:
      - pi-services

  netbox:
    container_name: netbox
    image: netboxcommunity/netbox:latest
    restart: unless-stopped
    depends_on:
      - netbox-db
      - netbox-redis
    volumes:
      - "${DOCKER_ROOT}/netbox/media:/opt/netbox/netbox/media"
      - "${DOCKER_ROOT}/netbox/reports:/opt/netbox/netbox/reports"
      - "${DOCKER_ROOT}/netbox/scripts:/opt/netbox/netbox/scripts"
    ports:
      - "8085:8080"
    environment:
      API_TOKEN_PEPPERS: "${NETBOX_API_TOKEN_PEPPERS}"
      SECRET_KEY: "${NETBOX_SECRET_KEY}"
      DB_NAME: "${NETBOX_DB_NAME}"
      DB_USER: "${NETBOX_DB_USER}"
      DB_PASSWORD: "${NETBOX_DB_PASSWORD}"
      DB_HOST: "netbox-db"
      REDIS_HOST: "netbox-redis"
      ALLOWED_HOSTS: "${NETBOX_ALLOWED_HOSTS}"
    networks:
      - pi-services


  nmap-scanner:
    build:
      context: .
      dockerfile: Dockerfile.scanner
    container_name: nmap-scanner
    volumes:
      - .:/app
    #    networks:
    #      - default
    network_mode: host
    cap_add:
      - NET_RAW
      - NET_ADMIN
    env_file: .env
    profiles: [ "tools" ]

  unifi-controller:
    container_name: unifi-controller
    image: lscr.io/linuxserver/unifi-network-application:latest
    restart: unless-stopped
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TZ}
      - MONGO_USER=unifi
      - MONGO_PASS=${NETBOX_DB_PASSWORD} # Hergebruik je bestaande veilige pass of maak een nieuwe .env variabele
      - MONGO_HOST=unifi-db
      - MONGO_PORT=27017
      - MONGO_DBNAME=unifi
    volumes:
      - "${DOCKER_ROOT}/unifi/config:/config"
    ports:
      - "8444:8443" # Web GUI (Aangepast naar 8444 om conflicten te vermijden)
      - "3479:3478/udp" # STUN
      - "10080:8080" # Device inform (Aangepast naar 10080 omdat AdGuard al op 8080 zit)
      - "1900:1900/udp" # L2 Discovery
      - "8843:8843" # HTTPS Portal
      - "8880:8880" # HTTP Portal
      - "6789:6789" # Mobile throughput test
      - "5514:5514/udp" # Remote syslog
    depends_on:
      - unifi-db
    networks:
      - pi-services

  unifi-db:
    container_name: unifi-db
    image: docker.io/mongo:7.0
    restart: unless-stopped
    volumes:
      - "${DOCKER_ROOT}/unifi/db:/data/db"
      - "${DOCKER_ROOT}/unifi/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro"
    networks:
      - pi-services

networks:
  pi-services:
    name: pi-services
    driver: bridge
  nextcloud-internal:
    name: nextcloud-internal
    driver: bridge
    internal: true
